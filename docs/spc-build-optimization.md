# SPC Build Optimization Playbook

Cold static-php-cli (SPC) builds slow down delivery, especially when each request triggers a full compile. The following playbook distills a layered approach for turning SPC outputs into reusable artifacts and shrinking build latency from minutes or hours to seconds.

## 0. Treat binaries as reusable artifacts

* Never compile on-demand per customer request.
* Resolve requests by reusing an existing artifact or queuing a cache-warmed build job that compiles only deltas.

## 1. Publish opinionated presets

* Maintain a narrow matrix of SKUs (OS × PHP version × extension pack).
* Cover the majority of demand with instant downloads for popular combinations (for example: Windows x64 PHP 8.3/8.4, Linux x64/arm64 PHP 8.3/8.4, and packs such as "Laravel", "NativePHP Desktop", and "Enterprise DB").
* Shipping superset extension packs increases file size but avoids build work at checkout time.

## 2. Pre-warm SPC caches

* Schedule `spc download --all --with-php=<version>` for supported versions (8.3, 8.4) to keep `source/` hot.
* Prefer SPC prebuilt libraries (`--prefer-pre-built`) to skip redundant compiles.
* Seed builders offline with `spc download --from-zip=/path/to/download.zip` generated by SPC actions.
* Compile PHP 8.3 once, then reuse the dependency tree for PHP 8.4 via `spc switch-php-version`.
* On Linux/glibc targets, rely on SPC's precompiled musl toolchain instead of rebuilding toolchains.

## 3. Persist heavyweight directories

* Cache and restore the SPC `source/` and `buildroot/` directories between jobs.
* Daily tars or persistent volumes allow later builds to skip downloads and repeated library compiles.

## 4. Windows fast-path strategy

* **Track A:** For most NativePHP desktop scenarios, redistribute the official PHP for Windows with curated `php.ini` and bundled `ext/*.dll` files—no compilation required.
* **Track B:** For static or niche builds, run SPC on cache-warmed builders following the Windows guide (MSVC + php-sdk-binary-tools) with the same persistence rules as above.

## 5. Establish a binary artifact registry

* Store build outputs in a content-addressed bucket (e.g., S3/R2) keyed by `os-arch | php_version | sapi | compiler_abi | extensions_sorted | zts | static/dynamic`.
* Check the registry before triggering a build; enqueue new work only when a combination is missing.

## 6. Bias towards packaging over compiling

* Compile superset binaries with many extensions enabled and ship variant `php.ini` presets.
* For Windows, ship the `.dll` files and toggle extensions through configuration.

## 7. Maintain healthy builders

* Keep long-lived builder hosts with all SPC prerequisites preinstalled.
* Use container images with `spc doctor` already satisfied.
* Mirror downloads locally or reuse weekly `download.zip` bundles.
* Layer in C/C++ compiler caches (ccache/sccache on Unix, clcache on Windows) when iterating on patches.

## 8. Constrain supported permutations

* Limit official support to PHP 8.3/8.4 initially and ship a compatibility matrix.
* Offer a small number of curated extension packs (e.g., "Laravel Web", "DB Full", "NativePHP Desktop").

## 9. FAQ

**Can we download official PHP and avoid compiling?**

* Windows: yes—redistribute the official binaries with the desired configuration.
* Linux/macOS: source-only distributions still require compiling; leverage warmed SPC caches and prebuilt libraries to minimize rebuild time.

**Can we download SPC libraries once and reuse them?**

* Yes—cache `source/` via `spc download --all` and hydrate from `download.zip`. Restore `buildroot/` to reuse compiled dependencies.

**How do we avoid redoing downloads/compiles per request?**

* Combine the artifact registry, nightly cache warmers, and curated presets. Only cache misses trigger new builds, and subsequent requests reuse the artifact instantly.

## Next steps

1. Publish the preset SKU matrix with matching `php.ini` profiles.
2. Provision a builder pipeline that performs nightly `spc download --all` runs with `--prefer-pre-built`, persisting `source/` and `buildroot/`.
3. Integrate the artifact registry lookup before SPC runs.
4. Limit custom orders to a small number of extension packs until demand proves otherwise.

